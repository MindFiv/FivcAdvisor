#!/usr/bin/env python
"""
FivcAdvisor CLI

Command-line interface for running FivcAdvisor agents and tools.
"""

import subprocess
import sys
import os
from typing import Optional
from pathlib import Path

import typer
from dotenv import load_dotenv
from rich.console import Console
from rich.panel import Panel
from rich.text import Text

from fivcadvisor import agents, tools
from fivcadvisor.utils import create_output_dir

load_dotenv()

app = typer.Typer(
    name="FivcAdvisor",
    help="FivcAdvisor - "
    "Intelligent agent ecosystem for "
    "autonomous tool generation and "
    "dynamic crew orchestration",
    rich_markup_mode="rich",
)

console = Console()


@app.command()
def run(
    agent_name: str = typer.Argument("Generic", help="Type of agent to run"),
    query: Optional[str] = typer.Option(
        None,
        "--query",
        "-q",
        help="User query to process (if not provided, will prompt interactively)",
    ),
    output: Optional[Path] = typer.Option(
        None, "--output", "-o", help="Output file path"
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", help="Show what would be done without executing"
    ),
    verbose: bool = typer.Option(
        False, "--verbose", "-v", help="Enable verbose output"
    ),
):
    """
    Run a FivcAdvisor agent
    """
    console.print(
        Panel.fit(
            Text("FivcAdvisor Agent Runner", style="bold blue"),
            subtitle="Intelligent Agent Ecosystem",
        )
    )

    if query is None:
        query = typer.prompt("Enter your query")
        if not query:
            console.print("[red]❌ Query cannot be empty[/red]")
            raise typer.Exit(1)

    agent_creator = agents.default_retriever.get(agent_name)
    if not agent_creator:
        console.print(f"[red]❌ Unknown agent type: {agent_name}[/red]")
        console.print(f"Available agents: {agents.default_retriever.get_all()}")
        raise typer.Exit(1)

    if dry_run:
        console.print(f"[yellow]DRY RUN:[/yellow] Would run {agent_name} agent")
        if query:
            console.print(f"[yellow]Query:[/yellow] {query}")
        if output:
            console.print(f"[yellow]Output:[/yellow] {output}")
        return

    agent = agent_creator(
        tools_retriever=tools.default_retriever,
        verbose=verbose,
    )

    with create_output_dir(base=output):
        try:
            agent(query)
            console.print("[green]✅ Agent completed successfully![/green]")
        except Exception as e:
            console.print(f"[red]❌ Error running agent: {e}[/red]")
            raise typer.Exit(1)


@app.command()
def clean():
    """
    Clean up temporary files generated by FivcAdvisor
    """
    console.print("[yellow]Cleaning up temporary files...[/yellow]")

    try:
        # Clean temp directories
        output_dir = create_output_dir()
        output_dir.cleanup(ignore_errors=False)
        console.print("[green]✅ Cleanup completed[/green]")

    except Exception as e:
        console.print(f"[red]❌ Error during cleanup: {e}[/red]")
        raise typer.Exit(1)


@app.command()
def web(
    port: int = typer.Option(
        8501, "--port", "-p", help="Port to run the web interface on"
    ),
    host: str = typer.Option(
        "0.0.0.0", "--host", "-h", help="Host to bind the web interface to"
    ),
    debug: bool = typer.Option(False, "--debug", help="Run in debug mode"),
):
    """
    Launch the FivcAdvisor web interface using Streamlit
    """
    console.print(
        Panel.fit(
            Text("FivcAdvisor Web Interface", style="bold green"),
            subtitle="Starting Streamlit Application",
        )
    )

    try:
        console.print(f"[blue]Starting web interface at http://{host}:{port}[/blue]")
        console.print("[yellow]Press Ctrl+C to stop the server[/yellow]")

        # Get the path to the app module
        app_path = os.path.join(os.path.dirname(__file__), "app", "__init__.py")

        # Build streamlit command
        cmd = [
            sys.executable,
            "-m",
            "streamlit",
            "run",
            app_path,
            "--server.port",
            str(port),
            "--server.address",
            host,
            "--server.headless",
            "true",
            "--browser.gatherUsageStats",
            "false",
        ]

        if not debug:
            cmd.extend(["--logger.level", "error"])

        # Run streamlit
        subprocess.run(cmd, check=True)

    except KeyboardInterrupt:
        console.print("\n[yellow]Web interface stopped by user[/yellow]")
    except subprocess.CalledProcessError as e:
        console.print(f"[red]❌ Error starting web interface: {e}[/red]")
        console.print(
            "[yellow]Make sure Streamlit is installed: pip install streamlit[/yellow]"
        )
        raise typer.Exit(1)
    except Exception as e:
        console.print(f"[red]❌ Unexpected error: {e}[/red]")
        raise typer.Exit(1)


@app.command()
def info():
    """
    Show information about FivcAdvisor
    """
    info_text = """
    [bold blue]FivcAdvisor[/bold blue]

    An intelligent agent ecosystem for autonomous tool generation,
    decision optimization, and dynamic crew orchestration.

    [bold]Features:[/bold]
    • Intelligent task assessment with consultant agents
    • Dynamic crew assembly based on task complexity
    • Autonomous tool generation and optimization
    • Event-driven agent orchestration

    [bold]Usage Examples:[/bold]
    fivcadvisor run Generic                                         # Interactive mode
    fivcadvisor run Generic --query "What is machine learning?"     # Programmatic mode
    fivcadvisor web                                                 # Launch web interface
    fivcadvisor clean                                               # Clean temporary files
    fivcadvisor info
    """

    console.print(Panel(info_text, title="FivcAdvisor", border_style="blue"))


def main():
    """
    Main entry point for the CLI
    """
    app()


if __name__ == "__main__":
    main()
